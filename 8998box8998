-- boxes.lua

local function CreateBox(Player, Environment, Camera)
    local Box = {}
    Box.BorderSquare = Drawing.new("Square")
    Box.BorderSquare.Color = Environment.Boxes.Settings.BoxSettings.Color
    Box.BorderSquare.Transparency = Environment.Boxes.Settings.BoxSettings.Transparency
    Box.BorderSquare.Thickness = Environment.Boxes.Settings.BoxSettings.Thickness
    Box.BorderSquare.Filled = false

    Box.FillSquare = Drawing.new("Square")
    Box.FillSquare.Color = Environment.Boxes.Settings.BoxSettings.FillColor
    Box.FillSquare.Transparency = Environment.Boxes.Settings.BoxSettings.FillTransparency
    Box.FillSquare.Thickness = 0
    Box.FillSquare.Filled = true

    Box.Update = function()
        if Player.Character and Player.Character:FindFirstChild("HumanoidRootPart") then
            local humanoid = Player.Character:FindFirstChildOfClass("Humanoid")
            if humanoid then
                local height = Player.Character.HumanoidRootPart.Size.Y * 2200
                local Pos, OnScreen = Camera:WorldToViewportPoint(Player.Character.HumanoidRootPart.Position)

                if OnScreen and Environment.Boxes.Settings.Enabled then
                    local sizeX = 2000 / Pos.Z
                    local sizeY = height / Pos.Z
                    
                    Box.BorderSquare.Size = Vector2.new(sizeX, sizeY)
                    Box.BorderSquare.Position = Vector2.new(Pos.X - sizeX / 2, Pos.Y - sizeY / 2.475)
                    Box.BorderSquare.Visible = true

                    Box.FillSquare.Size = Vector2.new(sizeX, sizeY)
                    Box.FillSquare.Position = Vector2.new(Pos.X - sizeX / 2, Pos.Y - sizeY / 2.475)
                    
                    Box.FillSquare.Visible = Environment.Boxes.Settings.BoxSettings.Filled
                else
                    Box.BorderSquare.Visible = false
                    Box.FillSquare.Visible = false
                end
            else
                Box.BorderSquare.Visible = false
                Box.FillSquare.Visible = false
            end
        else
            Box.BorderSquare.Visible = false
            Box.FillSquare.Visible = false
        end
    end

    Box.Remove = function()
        if Box.BorderSquare then
            Box.BorderSquare:Remove()
            Box.BorderSquare = nil
        end
        if Box.FillSquare then
            Box.FillSquare:Remove()
            Box.FillSquare = nil
        end
    end

    return Box
end

return {
    CreateBox = CreateBox
}
